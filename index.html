<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');

        :root {
            --bg-color: #f0f3f7;
            --accent: #ff7675;
            --primary: #6c5ce7;
            --text: #2d3436;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        h1.main-title {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 28px;
            text-align: center;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            white-space: nowrap;
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #00b894; }
        .btn-warning { background: #fdcb6e; color: #333; }
        .btn-shopping { background: #e17055; }
        .btn-magic { background: linear-gradient(135deg, #a29bfe, #74b9ff); }
        .btn-whatsapp { background: #25d366; }
        .btn-add { background: #fab1a0; color: #333; margin-top: 10px; width: 100%; }
        .btn-small-delete { background: #ff7675; color: white; padding: 8px; font-size: 14px; border-radius: 8px; }

        /* --- Setup Screen --- */
        #setup-screen {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 450px;
            width: 100%;
            margin-top: 10px;
            box-sizing: border-box;
        }

        .child-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .child-input-row input[type="text"] { flex: 1; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; outline: none; font-family: 'Rubik', sans-serif; font-size: 16px; }
        .child-input-row input[type="color"] { width: 40px; height: 40px; border: none; background: none; }
        .remove-row-btn { background: #ff7675; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; }

        /* --- Main App --- */
        #app-screen { display: none; width: 100%; max-width: 1200px; flex-direction: column; gap: 15px; margin-bottom: 80px; }
        
        .controls-bar { 
            background: white; padding: 10px; border-radius: 15px; display: flex; flex-wrap: wrap; 
            justify-content: space-between; align-items: center; gap: 10px; box-shadow: var(--shadow); 
            position: sticky; top: 5px; z-index: 100; 
        }
        .controls-group { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
        .controls-group .btn { flex-grow: 1; }

        .inventory-section { background: white; padding: 10px; border-radius: 15px; box-shadow: var(--shadow); }
        .tab-buttons { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 10px; padding-bottom: 5px; }
        .tab-button { background: #dfe6e9; padding: 8px 15px; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; }
        .tab-button.active { background: var(--primary); color: white; }

        .inventory-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-height: 200px; overflow-y: auto; padding: 5px; }

        /* Items */
        .food-item {
            width: 65px; height: 65px; background: white; border: 1px solid #dfe6e9; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; transition: all 0.2s; font-size: 10px; text-align: center;
            flex-shrink: 0; position: relative;
        }
        .food-item img { width: 35px; height: 35px; object-fit: contain; margin-bottom: 2px; }
        .food-item span.emoji { font-size: 26px; margin-bottom: 2px; display: block; }
        
        /* Highlight selected item */
        .food-item.selected-for-move {
            border: 3px solid var(--primary);
            background-color: #e3f2fd;
            transform: scale(1.1);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            z-index: 10;
        }

        /* "Add New" Item Button in Inventory */
        .add-item-btn {
            border: 2px dashed #aaa;
            background: #f9f9f9;
            color: #555;
            font-size: 30px;
            font-weight: bold;
        }
        .add-item-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
            background: #fff;
        }

        /* Categories Colors */
        .food-item[data-cat="bread"] { border-top: 3px solid #fdcb6e; }
        .food-item[data-cat="filling"] { border-top: 3px solid #ff7675; }
        .food-item[data-cat="veggie"] { border-top: 3px solid #00b894; }
        .food-item[data-cat="fruit"] { border-top: 3px solid #e17055; }
        .food-item[data-cat="treat"] { border-top: 3px solid #a29bfe; }

        /* Tables */
        #tables-container { width: 100%; overflow-x: auto; padding-bottom: 10px; -webkit-overflow-scrolling: touch; }
        .single-child-table { background: white; padding: 15px; border-radius: 20px; box-shadow: var(--shadow); min-width: 800px; margin-bottom: 20px; }
        .child-title { text-align: center; font-size: 22px; font-weight: bold; margin-bottom: 10px; padding: 8px; border-radius: 10px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        
        .week-grid { display: grid; grid-template-columns: 80px repeat(6, 1fr); gap: 4px; border: 1px solid rgba(0,0,0,0.1); padding: 5px; border-radius: 12px; }
        .header-cell { padding: 5px; text-align: center; font-weight: bold; border-radius: 6px; font-size: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); }
        .day-header { background: #ffeaa7 !important; }

        .day-cell {
            background: rgba(255,255,255,0.5); border-radius: 6px; min-height: 65px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px dashed rgba(0,0,0,0.2); cursor: pointer; position: relative; padding: 2px;
            transition: all 0.2s;
        }
        
        /* Hint + */
        .day-cell:not(.filled)::after {
            content: '+'; font-size: 24px; color: rgba(0,0,0,0.15); pointer-events: none; position: absolute;
        }
        
        /* Visual Feedback */
        .day-cell.drag-over {
            background-color: #dff9fb !important; border: 2px solid var(--primary) !important; transform: scale(1.02);
        }

        .day-cell .food-item { width: 100%; height: 100%; border: none; box-shadow: none; background: transparent; }
        
        /* Delete btn on cell */
        .cell-delete-btn {
            position: absolute; top: -5px; left: -5px; background: #ff7675; color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 20px;
            text-align: center; display: none; z-index: 5; box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .day-cell.filled:hover .cell-delete-btn { display: block; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; max-height: 80vh; overflow-y: auto; text-align: center; position: relative;}
        
        .form-group { margin-bottom: 15px; text-align: right; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-sizing: border-box; }

        #item-selector-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; margin-bottom: 15px; }
        .shopping-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; text-align: right; }
        .shopping-item .icon-and-name { display: flex; align-items: center; gap: 8px; }
        .shopping-item img { width: 24px; height: 24px; }

        /* Context Menu & Modals */
        #context-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 3000; overflow: hidden; }
        .ctx-item { padding: 10px 20px; cursor: pointer; font-size: 14px; }
        .ctx-item:hover { background: #f0f0f0; }

        /* --- Mobile adjustments --- */
        @media (max-width: 768px) {
            .inventory-header span.desktop-only { display: none; }
            .inventory-header::after { content: ' (×œ×—×¥ ×œ×‘×—×™×¨×”, ×œ×—×™×¦×” ××¨×•×›×” ×œ×¢×¨×™×›×”)'; font-size: 0.9em; color: #666; }
        }
        @media (min-width: 769px) {
             .inventory-header span.mobile-only { display: none; }
        }


        /* --- PRINT OPTIMIZATION (Fixes for Mobile A4 Landscape) --- */
        @media print {
            @page {
                size: A4 landscape;
                margin: 0; /* Remove default margins to control manually */
            }
            
            body, html {
                margin: 0; 
                padding: 0; 
                width: 100%; 
                height: 100%;
                background: white;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            /* Clear non-printable elements */
            .inventory-section, .controls-bar, h1.main-title, .modal, #setup-screen, .cell-delete-btn, #context-menu { 
                display: none !important; 
            }
            
            #app-screen { 
                display: block !important; 
                margin: 0 !important; 
                padding: 5mm !important; /* Safe padding for print */
                width: 100% !important;
                box-sizing: border-box;
            }

            #tables-container { 
                display: block !important;
                overflow: visible !important; 
                width: 100% !important;
            }

            .single-child-table {
                width: 100% !important;
                min-width: 0 !important;
                box-shadow: none !important;
                border: none !important;
                margin: 0 0 1cm 0 !important;
                padding: 0 !important;
                page-break-after: always;
                page-break-inside: avoid;
            }

            .child-title {
                font-size: 20pt !important;
                padding: 5px !important;
                background-color: rgba(200,200,200,0.3) !important;
                border: 2px solid #000;
                border-bottom: none;
                color: #000 !important;
                margin: 0 !important;
                border-radius: 0 !important;
            }

            /* Responsive Grid for Print using Percentages */
            .week-grid { 
                display: grid !important;
                /* Use percentages to ensure it fits any A4 rendering logic */
                grid-template-columns: 10% 15% 15% 15% 15% 15% 15% !important;
                gap: 0 !important;
                border: 2px solid #000 !important;
                width: 100% !important;
            }

            .header-cell { 
                font-size: 12pt !important; 
                background-color: #eee !important; 
                border: 1px solid #000 !important;
                color: #000 !important;
                padding: 5px !important;
                overflow: hidden;
            }

            .day-cell { 
                border: 1px solid #000 !important;
                min-height: 2.5cm !important; /* Fixed reasonable height for print */
                display: flex !important;
                align-items: center !important;
                justify-content: center !important;
                padding: 2px !important;
            }

            .day-cell:not(.filled)::after { content: ''; }

            .day-cell .food-item {
                border: none !important;
                width: auto !important;
            }

            .day-cell .food-item img, .day-cell .food-item span.emoji {
                width: 1.2cm !important; /* Physical units for print */
                height: 1.2cm !important;
                font-size: 30pt !important;
            }
            
            .day-cell .food-item span:not(.emoji) {
                font-size: 10pt !important;
                color: #000 !important;
                font-weight: bold;
                white-space: normal !important; /* Allow wrapping in print */
            }
        }
    </style>
</head>
<body>

    <h1 class="main-title">×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™ ğŸ±</h1>

    <div id="setup-screen">
        <h2>×”×’×“×¨×ª ×™×œ×“×™× ğŸ¨</h2>
        <div id="children-list-container"></div>
        <button class="btn btn-add" onclick="addChildRow()">+ ×”×•×¡×£ ×™×œ×“</button>
        <br><br>
        <button class="btn btn-primary" style="width: 100%; font-size: 18px; padding: 12px;" onclick="startApp()">×”×ª×—×œ ×œ×¢×¦×‘! ğŸš€</button>
    </div>

    <div id="app-screen">
        <div class="controls-bar">
            <div class="controls-group">
                <button class="btn btn-shopping" onclick="showShoppingList()">ğŸ›’ ×¨×©×™××”</button>
                <button class="btn btn-success" onclick="window.print()">ğŸ“¸ ×©××•×¨</button>
                <button class="btn btn-magic" onclick="autoFillMenu()">ğŸª„ ××•×˜×•××˜×™</button>
            </div>
            <button class="btn btn-warning" style="flex:0;" onclick="clearTable()">ğŸ§¹</button>
        </div>

        <div class="inventory-section">
            <h4 style="margin:0 0 10px 0; text-align:center;">××—×¡×Ÿ ××•×¦×¨×™× <span class="desktop-only">(×’×¨×•×¨ ××• ×œ×—×¥)</span></h4>
            <div class="tab-buttons"></div>
            <div id="inventory-list" class="inventory-list"></div>
        </div>

        <div id="tables-container"></div>
    </div>

    <div id="new-item-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary)">×”×•×¡×¤×ª ×××›×œ ×—×“×© â•</h3>
            <div class="form-group">
                <label>×©× ×”×××›×œ:</label>
                <input type="text" id="modal-food-name" placeholder="×œ×“×•×’××”: ×‘×•×¨×§×¡">
            </div>
            <div class="form-group">
                <label>×§×˜×’×•×¨×™×”:</label>
                <select id="modal-food-cat"></select>
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn btn-primary" style="flex:1" onclick="addNewItemFromModal()">×”×•×¡×£</button>
                <button class="btn btn-warning" style="flex:1" onclick="closeModal('new-item-modal')">×‘×™×˜×•×œ</button>
            </div>
        </div>
    </div>

    <div id="item-selector-modal" class="modal">
        <div class="modal-content">
            <h3 id="selector-title">×‘×—×¨ ×¤×¨×™×˜</h3>
            <div id="item-selector-list"></div>
            <div style="margin-top: 15px; display:flex; gap:10px;">
                <button class="btn btn-small-delete" style="flex:1" onclick="deleteItemFromCell()">ğŸ—‘ï¸ × ×§×” ×ª×</button>
                <button class="btn btn-primary" style="flex:1" onclick="closeModal('item-selector-modal')">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <div id="shopping-modal" class="modal">
        <div class="modal-content">
            <h3>×¨×©×™××ª ×§× ×™×•×ª ğŸ“</h3>
            <div id="shopping-list-items"></div>
            <br>
            <button class="btn btn-whatsapp" style="width:100%; margin-bottom:10px;" onclick="copyToWhatsapp()">×”×¢×ª×§ ×œ×•×•××˜×¡××¤ ğŸ’¬</button>
            <button class="btn btn-primary" style="width:100%" onclick="closeModal('shopping-modal')">×¡×’×•×¨</button>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="changeItemImage()">ğŸ–¼ï¸ ×©× ×” ×ª××•× ×” (URL)</div>
        <div class="ctx-item" onclick="deleteItemFromInventory()" style="color:red">ğŸ—‘ï¸ ××—×§ ××”××—×¡×Ÿ</div>
    </div>

    <script>
        // --- Data ---
        const categories = [
            { id: 'bread', name: '×¤×—××™××”', icon: 'ğŸ' },
            { id: 'filling', name: '×—×œ×‘×•×Ÿ/×××¨×—', icon: 'ğŸ§€' },
            { id: 'veggie', name: '×™×¨×§', icon: 'ğŸ¥’' },
            { id: 'fruit', name: '×¤×¨×™', icon: 'ğŸ' },
            { id: 'treat', name: '×¤×™× ×•×§', icon: 'ğŸª' }
        ];
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™'];
        
        const iconDictionary = {
            '×’\'×—× ×•×Ÿ': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcSjCf98VhLbeXmSTL-Qe8RfwUkJpk9a7KDWUY5X_0MRGw&s=10' },
            '×‘×™×™×’×œ×” ×©×•××©×•×': { type: 'img', src: 'https://www.nika-cakes.co.il/wp-content/uploads/2020/12/Romanian-pretzel.jpg' },
            '××‘×•×§×“×•': { type: 'img', src: 'https://i0.wp.com/lyb.co.il/wp-content/uploads/2021/01/half-of-avocado-.jpg?fit=764%2C1024&ssl=1' },
            '×ª××¨': { type: 'img', src: 'https://st1.foodsd.co.il/Images/Products/large/uW5nT0cbTD7gyfDt.jpg' },
            '×¢×’×‘× ×™×™×ª ×©×¨×™': { type: 'img', src: 'https://www.ecolution.co.il/wp-content/uploads/2025/02/lobelo-%D7%A2%D7%92%D7%91%D7%A0%D7%99%D7%99%D7%AA-%D7%A9%D7%A8%D7%99-%D7%9C%D7%95%D7%91%D7%9C%D7%95-600x999.jpg' },
            '×’××‘×”': { type: 'img', src: 'https://hevdel.co.il/wp-content/uploads/2021/02/bell-peppers-421087_640.jpg' },
            '×©×•×§×•×œ×“ ×”×©×—×¨': { type: 'img', src: 'https://res.cloudinary.com/shufersal/image/upload/f_auto,q_auto/v1551800922/prod/product_images/products_large/QJU14_L_P_416021_1.png' },
            '× ×•×˜×œ×”': { type: 'img', src: 'https://res.cloudinary.com/shufersal/image/upload/f_auto,q_auto/v1551800922/prod/product_images/products_large/JEB38_L_P_80135876_1.png' },
            '××•×¦×¨×œ×” ××’×•×¨×“×ª': { type: 'img', src: 'https://manhaadama.co.il/wp-content/uploads/2022/01/Mock-Up2.jpg' },
            '××•×¦×¨×œ×” ×‘×™×™×‘×™': { type: 'img', src: 'https://noyhasade.b-cdn.net/wp-content/uploads/2021/01/baby_mozarella2.jpg' },
            '×’××•×“×” ×§×•×‘×™×•×ª': { type: 'img', src: 'https://www.hamoshava.co.il/wp-content/uploads/2025/04/%D7%92%D7%90%D7%95%D7%93%D7%94-%D7%94%D7%95%D7%9C%D7%A0%D7%93%D7%99%D7%AA-%D7%9E%D7%A9%D7%95%D7%9C%D7%A9.jpg' },
            '×¤×˜×” ×¢×™×–×™×': { type: 'img', src: 'https://www.carmella.co.il/wp-content/uploads/2022/08/7290001499303.jpg' },
            '×—×‘×™×ª×”': { type: 'img', src: 'https://www.kipa.co.il/userFiles/2025/11/1200-680/334694_%D7%97%D7%91%D7%99%D7%AA%D7%94_2.jpg' },
            '×œ×—×× ×™×”': 'ğŸ¥–', '×œ×‘×™×‘×•×ª': 'ğŸ¥', '×œ×—× ××œ×': 'ğŸ', '×¤×™×ª×”': 'ğŸ¥™', '×‘×™×™×’×œ×”': 'ğŸ¥¨', '×œ×—×': 'ğŸ', '×˜×•×¡×˜': 'ğŸ¥ª',
            '×‘×œ×™× ×¦×¡': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmtCm9Bu4wczi_0LUyr29ux-xOfFnzeLq_6bvycZPmBA&s=10' },
            '×××¨×— ×©×•×§×•×œ×“': 'ğŸ«', '×‘×™×¦×” ×§×©×”': 'ğŸ¥š', '×¤×¡×˜×¨××”': 'ğŸ¥©', '×’×‘×™× ×” ×¦×”×•×‘×”': 'ğŸ§€',
            '×’×‘×™× ×” ×œ×‘× ×”': { type: 'img', src: 'https://noyhasade.b-cdn.net/wp-content/uploads/2020/09/7290002824183-2.jpg'},
            '×‘×•×œ×’×¨×™×ª': { type: 'img', src: 'https://gad-dairy.co.il/wp-content/uploads/2016/05/30056-13-a_pic_site_9-1024x1024.png' },
            '×’×‘×™× ×ª ×©×× ×ª': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtiZ7V4aeVC52RnVhqm5FHQpxuQ8wk182azK07MmJ9Rg&s=10' },
            '×ª×•×ª×™×': 'ğŸ“', '×ª×¤×•×—': 'ğŸ', '××•×›×× ×™×•×ª': 'ğŸ«', '×©×–×™×£': 'ğŸŸ£', '×× ×’×•': 'ğŸ¥­', '×§×™×•×•×™': 'ğŸ¥', '×‘× × ×”': 'ğŸŒ', '×¢× ×‘×™×': 'ğŸ‡',
            '×ª×¤×•': 'ğŸŠ', '×–×™×ª×™× ×™×¨×•×§×™×': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcQDEp9HNy_nTQQl-Pe7cD2fw3XEIUHvFCJCqH_2v2Y4uw&s=10' }, '××œ×¤×¤×•×Ÿ': 'ğŸ¥’', '××œ×¤×¤×•×Ÿ ×—××•×¥': 'ğŸ¥’', '×¢×’×‘× ×™×•×ª ×©×¨×™': 'ğŸ…', '×¤×œ×¤×œ ×’××‘×”': 'ğŸ«‘', '×¢×’×‘× ×™×”': 'ğŸ…', '×’×–×¨': 'ğŸ¥•',
            '×§×¨×§×¨×™×': { type: 'img', src: 'https://st1.foodsd.co.il/Images/Products/large/Yz1gR9k5ej75oC8J.jpg' },
            '×™×•×’×•×¨×˜': 'ğŸ¥›', '×¤×ª×™ ×‘×¨': 'ğŸª', '××™×¥ ×ª×¤×•×–×™×': 'ğŸ§ƒ', '×§××¤×§×™×™×§': 'ğŸ§', '×‘×™×™×’×œ×” (×—×˜×™×£)': 'ğŸ¥¨', '×—×˜×™×£': 'ğŸ¬',
            '××§×˜×™××œ': { type: 'img', src: 'https://www.emess.co.il/resize/?width=800&height=450&url=/uploads/2024/08/%D7%90%D7%A7%D7%98%D7%99%D7%9E%D7%9C.jpg' },
            '×›×“×•×¨ ×©×•×§×•×œ×“': { type: 'img', src: 'https://cakenet.co.il/wp-content/uploads/2019/02/0_02891.jpg' },
            'bread': 'ğŸ', 'filling': 'ğŸ§€', 'veggie': 'ğŸ¥’', 'fruit': 'ğŸ', 'treat': 'ğŸª' 
        };

        let allInventoryItems = [
            { name: '×’\'×—× ×•×Ÿ', cat: 'bread' }, { name: '×‘×™×™×’×œ×” ×©×•××©×•×', cat: 'bread' }, { name: '×œ×—×× ×™×”', cat: 'bread' }, { name: '×¤×™×ª×”', cat: 'bread' }, { name: '×‘×œ×™× ×¦×¡', cat: 'bread' }, { name: '×˜×•×¡×˜', cat: 'bread' },
            { name: '×’×‘×™× ×” ×œ×‘× ×”', cat: 'filling' }, { name: '××‘×•×§×“×•', cat: 'filling' }, { name: '×—×‘×™×ª×”', cat: 'filling' }, { name: '×©×•×§×•×œ×“ ×”×©×—×¨', cat: 'filling' }, { name: '×’×‘×™× ×” ×¦×”×•×‘×”', cat: 'filling' }, { name: '×‘×•×œ×’×¨×™×ª', cat: 'filling' }, { name: '×’×‘×™× ×ª ×©×× ×ª', cat: 'filling' }, { name: '×‘×™×¦×” ×§×©×”', cat: 'filling' },
            { name: '×’×–×¨', cat: 'veggie' }, { name: '×¢×’×‘× ×™×™×ª ×©×¨×™', cat: 'veggie' }, { name: '×’××‘×”', cat: 'veggie' }, { name: '××œ×¤×¤×•×Ÿ', cat: 'veggie' }, { name: '×–×™×ª×™× ×™×¨×•×§×™×', cat: 'veggie' },
            { name: '×ª××¨', cat: 'fruit' }, { name: '×ª×¤×•×—', cat: 'fruit' }, { name: '×‘× × ×”', cat: 'fruit' }, { name: '×¢× ×‘×™×', cat: 'fruit' },
            { name: '××•×¦×¨×œ×” ×‘×™×™×‘×™', cat: 'treat' }, { name: '×§×¨×§×¨×™×', cat: 'treat' }, { name: '×™×•×’×•×¨×˜', cat: 'treat' }, { name: '××§×˜×™××œ', cat: 'treat' }, { name: '×›×“×•×¨ ×©×•×§×•×œ×“', cat: 'treat' }
        ];

        let childrenData = [];
        let selectedInventoryItem = null;
        let currentCellTarget = null;
        let activeCategory = 'bread';
        let longPressTimer;

        // --- Init ---
        document.addEventListener('DOMContentLoaded', () => {
            const catSelect = document.getElementById('modal-food-cat');
            catSelect.innerHTML = '';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.innerText = `${cat.icon} ${cat.name}`;
                catSelect.appendChild(option);
            });
            
            if (document.getElementById('children-list-container').children.length === 0) {
                addChildRow('××•×¨×™', '#539fec');
            }
        });

        // --- Functions ---
        window.addChildRow = function(name = '', color = '#a29bfe') {
            const container = document.getElementById('children-list-container');
            const div = document.createElement('div');
            div.className = 'child-input-row';
            const canRemove = container.children.length > 0 || name === ''; 
            div.innerHTML = `
                <input type="text" placeholder="×©× ×”×™×œ×“/×”" value="${name}">
                <input type="color" value="${color}">
                ${canRemove ? '<button class="remove-row-btn" onclick="this.parentElement.remove()">x</button>' : ''}
            `;
            container.appendChild(div);
        }

        window.startApp = function() {
            const rows = document.querySelectorAll('.child-input-row');
            childrenData = [];
            rows.forEach(row => {
                const name = row.querySelector('input[type="text"]').value.trim();
                const color = row.querySelector('input[type="color"]').value;
                if(name) childrenData.push({ name, color });
            });
            if (childrenData.length === 0) return alert('× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×™×œ×“ ××—×“');

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            
            initInventoryTabs();
            initInventory('bread');
            buildTables();
        }

        function resolveIcon(name, cat, customUrl = null) {
            if (customUrl) return `<img src="${customUrl}">`;
            if (iconDictionary[name]) {
                const val = iconDictionary[name];
                if (typeof val === 'object') return `<img src="${val.src}">`;
                return `<span class="emoji">${val}</span>`;
            }
            const fallback = iconDictionary[cat] || 'ğŸ±';
            return `<span class="emoji">${fallback}</span>`;
        }

        function initInventoryTabs() {
            const container = document.querySelector('.tab-buttons');
            container.innerHTML = '';
            categories.forEach((cat, idx) => {
                const btn = document.createElement('div');
                btn.className = `tab-button ${idx===0?'active':''}`;
                btn.innerText = `${cat.icon} ${cat.name}`;
                btn.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    initInventory(cat.id);
                };
                container.appendChild(btn);
            });
        }

        function initInventory(catId) {
            activeCategory = catId;
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            selectedInventoryItem = null;
            
            const filtered = allInventoryItems.filter(i => i.cat === catId);
            filtered.forEach(item => {
                const el = document.createElement('div');
                el.className = 'food-item';
                el.draggable = true;
                el.innerHTML = resolveIcon(item.name, item.cat, item.customUrl) + `<span>${item.name}</span>`;
                
                el.addEventListener('dragstart', (ev) => {
                    ev.dataTransfer.setData("application/json", JSON.stringify(item));
                });

                el.onclick = () => {
                    if (selectedInventoryItem === item) {
                        selectedInventoryItem = null;
                        el.classList.remove('selected-for-move');
                    } else {
                        document.querySelectorAll('.inventory-list .food-item').forEach(x => x.classList.remove('selected-for-move'));
                        selectedInventoryItem = item;
                        el.classList.add('selected-for-move');
                    }
                };

                // Mobile Long Press
                el.addEventListener('touchstart', (e) => {
                     longPressTimer = setTimeout(() => showContextMenu(e, item), 800); 
                });
                el.addEventListener('touchend', () => clearTimeout(longPressTimer));
                el.addEventListener('touchmove', () => clearTimeout(longPressTimer));
                
                // Desktop Right Click
                el.addEventListener('contextmenu', (e) => showContextMenu(e, item));

                list.appendChild(el);
            });

            // ADD BUTTON at end
            const addBtn = document.createElement('div');
            addBtn.className = 'food-item add-item-btn';
            addBtn.innerHTML = '+';
            addBtn.title = '×”×•×¡×£ ×××›×œ ×—×“×©';
            addBtn.onclick = () => openAddModal(catId);
            list.appendChild(addBtn);
        }

        window.openAddModal = function(catId) {
            document.getElementById('modal-food-name').value = '';
            document.getElementById('modal-food-cat').value = catId;
            document.getElementById('new-item-modal').style.display = 'flex';
        }

        window.addNewItemFromModal = function() {
            const name = document.getElementById('modal-food-name').value.trim();
            const cat = document.getElementById('modal-food-cat').value;
            if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©× ×œ×××›×œ');
            allInventoryItems.unshift({name, cat});
            closeModal('new-item-modal');
            
            const tabBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.innerText.includes(categories.find(c=>c.id===cat).name));
            if(tabBtn) tabBtn.click();
            else initInventory(cat);
        }

        function hexToRgba(hex, alpha) {
            let r=0, g=0, b=0;
            if(hex.length==4){r="0x"+hex[1]+hex[1];g="0x"+hex[2]+hex[2];b="0x"+hex[3]+hex[3];}
            else if(hex.length==7){r="0x"+hex[1]+hex[2];g="0x"+hex[3]+hex[4];b="0x"+hex[5]+hex[6];}
            return `rgba(${+r},${+g},${+b},${alpha})`;
        }

        function buildTables() {
            const container = document.getElementById('tables-container');
            container.innerHTML = ''; 
            
            childrenData.forEach(child => {
                const card = document.createElement('div');
                card.className = 'single-child-table';
                card.innerHTML = `<div class="child-title" style="background:${child.color}">×”×ª×¤×¨×™×˜ ×©×œ ${child.name}</div>`;
                
                const grid = document.createElement('div');
                grid.className = 'week-grid';
                grid.style.backgroundColor = hexToRgba(child.color, 0.3);

                const corner = document.createElement('div');
                corner.className = 'header-cell';
                corner.innerText = '×§×˜×’×•×¨×™×”';
                grid.appendChild(corner);

                days.forEach(d => {
                    const th = document.createElement('div');
                    th.className = 'header-cell day-header';
                    th.innerText = d;
                    grid.appendChild(th);
                });

                categories.forEach(cat => {
                    const ch = document.createElement('div');
                    ch.className = 'header-cell';
                    ch.innerHTML = `${cat.icon}<br>${cat.name}`;
                    grid.appendChild(ch);

                    days.forEach(day => {
                        const cell = document.createElement('div');
                        cell.className = 'day-cell';
                        cell.setAttribute('data-cat', cat.id);
                        
                        cell.addEventListener('dragover', (e) => { e.preventDefault(); cell.classList.add('drag-over'); });
                        cell.addEventListener('dragleave', () => cell.classList.remove('drag-over'));
                        cell.addEventListener('drop', (e) => {
                            e.preventDefault(); cell.classList.remove('drag-over');
                            const data = e.dataTransfer.getData("application/json");
                            if(data) populateCell(cell, JSON.parse(data));
                        });

                        cell.onclick = () => {
                            if(selectedInventoryItem) {
                                populateCell(cell, selectedInventoryItem);
                            } else {
                                openItemSelector(cell, cat.id);
                            }
                        };
                        grid.appendChild(cell);
                    });
                });
                card.appendChild(grid);
                container.appendChild(card);
            });
        }

        function populateCell(cell, item) {
            cell.innerHTML = '';
            if(!item) { 
                cell.classList.remove('filled'); 
                return; 
            }
            
            cell.classList.add('filled');
            const div = document.createElement('div');
            div.className = 'food-item';
            div.innerHTML = resolveIcon(item.name, item.cat, item.customUrl) + `<span>${item.name}</span>`;
            div.draggable = true;
            div.addEventListener('dragstart', (ev) => {
               ev.dataTransfer.setData("application/json", JSON.stringify(item));
            });
            
            const del = document.createElement('div');
            del.className = 'cell-delete-btn';
            del.innerText = 'x';
            del.onclick = (e) => { e.stopPropagation(); populateCell(cell, null); };
            
            cell.appendChild(div);
            cell.appendChild(del);
        }

        function openItemSelector(cell, catId) {
            currentCellTarget = cell;
            const list = document.getElementById('item-selector-list');
            list.innerHTML = '';
            
            const relevant = allInventoryItems.filter(x => x.cat === catId);
            relevant.forEach(item => {
                const el = document.createElement('div');
                el.className = 'food-item';
                el.innerHTML = resolveIcon(item.name, item.cat, item.customUrl) + `<span>${item.name}</span>`;
                el.onclick = () => {
                    populateCell(cell, item);
                    closeModal('item-selector-modal');
                };
                list.appendChild(el);
            });
            
            document.getElementById('item-selector-modal').style.display = 'flex';
        }

        window.deleteItemFromCell = function() {
            if(currentCellTarget) populateCell(currentCellTarget, null);
            closeModal('item-selector-modal');
        }

        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }

        // --- Context Menu ---
        window.showContextMenu = function(e, itemObj) {
            e.preventDefault();
            contextTargetItem = itemObj;
            const ctxMenu = document.getElementById('context-menu');
            ctxMenu.style.display = 'block';
            let pageX = e.pageX || (e.touches ? e.touches[0].pageX : 0);
            let pageY = e.pageY || (e.touches ? e.touches[0].pageY : 0);
            ctxMenu.style.left = pageX + 'px';
            ctxMenu.style.top = pageY + 'px';
        }
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#context-menu')) document.getElementById('context-menu').style.display = 'none';
        });
        document.addEventListener('touchstart', (e) => {
             if (!e.target.closest('#context-menu')) document.getElementById('context-menu').style.display = 'none';
        });

        window.changeItemImage = function() {
            if(!contextTargetItem) return;
            const url = prompt('×”×›× ×¡ ×§×™×©×•×¨ ×œ×ª××•× ×”:', contextTargetItem.customUrl || '');
            if(url !== null) { 
                contextTargetItem.customUrl = url || null; 
                initInventory(activeCategory);
            }
            document.getElementById('context-menu').style.display = 'none';
        }

        window.deleteItemFromInventory = function() {
             if(!contextTargetItem) return;
             if(confirm('×œ××—×•×§ ××ª ' + contextTargetItem.name + '?')) {
                 allInventoryItems = allInventoryItems.filter(i => i !== contextTargetItem);
                 initInventory(activeCategory);
             }
             document.getElementById('context-menu').style.display = 'none';
        }

        window.showShoppingList = function() {
            const summary = {};
            document.querySelectorAll('.day-cell.filled .food-item span:last-child').forEach(sp => {
                const name = sp.innerText;
                summary[name] = (summary[name] || 0) + 1;
            });
            
            const list = document.getElementById('shopping-list-items');
            list.innerHTML = '';
            let text = "×¨×©×™××ª ×§× ×™×•×ª:\n";
            
            if(Object.keys(summary).length === 0) list.innerHTML = "×”×œ×•×— ×¨×™×§!";
            else {
                for(let [k,v] of Object.entries(summary)) {
                    list.innerHTML += `<div class="shopping-item"><span>${k}</span><span>${v}</span></div>`;
                    text += `${k}: ${v}\n`;
                }
            }
            window.shoppingListText = text;
            document.getElementById('shopping-modal').style.display = 'flex';
        }

        window.copyToWhatsapp = function() {
            navigator.clipboard.writeText(window.shoppingListText).then(()=>alert('×”×•×¢×ª×§!'));
        }

        window.autoFillMenu = function() {
            document.querySelectorAll('.day-cell').forEach(cell => {
                const cat = cell.getAttribute('data-cat');
                const rel = allInventoryItems.filter(x => x.cat === cat);
                if(rel.length) populateCell(cell, rel[Math.floor(Math.random()*rel.length)]);
            });
        }

        window.clearTable = function() {
            if(confirm('×œ× ×§×•×ª ×”×›×œ?')) document.querySelectorAll('.day-cell').forEach(c => populateCell(c, null));
        }
    </script>
</body>
</html>
