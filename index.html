<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');

        :root {
            --bg-color: #f0f3f7;
            --primary: #6c5ce7;
            --text: #2d3436;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        * { box-sizing: border-box; }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            -webkit-tap-highlight-color: transparent;
        }

        h1.main-title {
            color: var(--primary);
            margin-bottom: 15px;
            font-size: 28px;
            text-align: center;
        }

        /* --- Buttons --- */
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:active { transform: scale(0.95); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #00b894; }
        .btn-warning { background: #fdcb6e; color: #333; }
        .btn-shopping { background: #e17055; }
        .btn-magic { background: linear-gradient(135deg, #a29bfe, #74b9ff); }
        .btn-google { background: #4285F4; font-size: 13px; padding: 8px; width: 100%; margin-bottom: 5px;}
        .btn-add { background: #fab1a0; color: #333; margin-top: 10px; width: 100%; }

        /* --- Setup Screen --- */
        #setup-screen {
            background: white;
            padding: 20px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 450px;
            width: 100%;
            margin-top: 10px;
        }

        .child-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .child-input-row input[type="text"] { flex: 1; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; outline: none; font-size: 16px; font-family: 'Rubik', sans-serif;}
        
        .color-picker-wrapper { position: relative; width: 40px; height: 40px; overflow: hidden; border-radius: 50%; cursor: pointer; border: 2px solid #ddd; }
        .color-picker-wrapper input[type="color"] { position: absolute; top: -50%; left: -50%; width: 200%; height: 200%; cursor: pointer; border: none; padding: 0; margin: 0; }
        .remove-row-btn { background: #ff7675; color: white; border: none; border-radius: 50%; width: 30px; height: 30px; font-weight: bold; cursor: pointer; }

        /* --- Main App --- */
        #app-screen { display: none; width: 100%; max-width: 1200px; flex-direction: column; gap: 15px; margin-bottom: 80px; }
        
        .controls-bar { 
            background: white; padding: 10px; border-radius: 15px; display: flex; flex-wrap: wrap; 
            justify-content: space-between; align-items: center; gap: 10px; box-shadow: var(--shadow); 
            position: sticky; top: 5px; z-index: 100; 
        }
        .controls-group { display: flex; gap: 5px; flex-wrap: wrap; flex: 1; }
        .controls-group .btn { flex-grow: 1; }

        .inventory-section { background: white; padding: 10px; border-radius: 15px; box-shadow: var(--shadow); }
        .tab-buttons { display: flex; overflow-x: auto; gap: 5px; margin-bottom: 10px; padding-bottom: 5px; }
        .tab-button { background: #dfe6e9; padding: 8px 15px; border-radius: 20px; white-space: nowrap; font-size: 14px; cursor: pointer; }
        .tab-button.active { background: var(--primary); color: white; }

        .inventory-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-height: 200px; overflow-y: auto; padding: 5px; }

        .food-item {
            width: 65px; height: 65px; background: white; border: 1px solid #dfe6e9; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; user-select: none; transition: all 0.2s; font-size: 10px; text-align: center;
            flex-shrink: 0; position: relative;
        }
        .food-item img { width: 35px; height: 35px; object-fit: contain; margin-bottom: 2px; }
        .food-item span.emoji { font-size: 26px; margin-bottom: 2px; display: block; }
        
        .food-item.selected-for-move {
            border: 3px solid var(--primary);
            background-color: #e3f2fd;
            transform: scale(1.1);
            z-index: 10;
        }

        .add-item-btn { border: 2px dashed #aaa; background: #f9f9f9; color: #555; font-size: 30px; font-weight: bold; }
        
        /* Categories Colors */
        .food-item[data-cat="bread"] { border-top: 3px solid #fdcb6e; }
        .food-item[data-cat="filling"] { border-top: 3px solid #ff7675; }
        .food-item[data-cat="veggie"] { border-top: 3px solid #00b894; }
        .food-item[data-cat="fruit"] { border-top: 3px solid #e17055; }
        .food-item[data-cat="treat"] { border-top: 3px solid #a29bfe; }

        /* Tables */
        #tables-container { width: 100%; overflow-x: auto; padding-bottom: 10px; }
        .single-child-table { background: white; padding: 15px; border-radius: 20px; box-shadow: var(--shadow); min-width: 800px; margin-bottom: 20px; transition: all 0.3s; }
        
        .child-title { 
            text-align: center; font-size: 22px; font-weight: bold; margin-bottom: 10px; 
            padding: 8px; border-radius: 10px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); 
            display: flex; align-items: center; justify-content: center; gap: 10px; position: relative;
        }

        /* Color Edit Button on Main Screen */
        .edit-color-btn {
            background: rgba(255,255,255,0.3);
            border: 1px solid rgba(255,255,255,0.6);
            width: 30px; height: 30px;
            border-radius: 50%;
            cursor: pointer;
            display: flex; align-items: center; justify-content: center;
            font-size: 16px;
            position: relative;
            overflow: hidden;
        }
        .edit-color-btn input[type="color"] {
            position: absolute; top: -10px; left: -10px; width: 50px; height: 50px; opacity: 0; cursor: pointer;
        }

        .week-grid { display: grid; grid-template-columns: 80px repeat(6, 1fr); gap: 4px; border: 1px solid rgba(0,0,0,0.1); padding: 5px; border-radius: 12px; }
        .header-cell { padding: 5px; text-align: center; font-weight: bold; border-radius: 6px; font-size: 12px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); }
        .day-header { background: #ffeaa7 !important; }

        .day-cell {
            background: rgba(255,255,255,0.5); border-radius: 6px; min-height: 65px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px dashed rgba(0,0,0,0.2); cursor: pointer; position: relative; padding: 2px;
        }
        .day-cell.filled { border-style: solid; background: rgba(255,255,255,0.8); }
        
        .cell-delete-btn {
            position: absolute; top: -5px; left: -5px; background: #ff7675; color: white;
            border-radius: 50%; width: 20px; height: 20px; font-size: 12px; line-height: 20px;
            text-align: center; display: none; z-index: 5;
        }
        .day-cell.filled:hover .cell-delete-btn { display: block; }

        /* Modals */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 20px; width: 90%; max-width: 350px; max-height: 90vh; overflow-y: auto; text-align: center; }
        
        .form-group { margin-bottom: 15px; text-align: right; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Rubik'; }

        /* Emoji Picker */
        .emoji-picker { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 5px; padding: 10px; background: #f9f9f9; border-radius: 8px; max-height: 120px; overflow-y: auto; }
        .emoji-option { font-size: 24px; cursor: pointer; padding: 5px; border-radius: 5px; }
        .emoji-option:hover, .emoji-option.selected { background: #e3f2fd; transform: scale(1.2); }

        /* Advanced Section */
        .advanced-section { margin-top: 20px; padding-top: 15px; border-top: 1px dashed #ccc; text-align: center; }
        .advanced-toggle { font-size: 12px; color: #666; text-decoration: underline; cursor: pointer; margin-bottom: 10px; }
        .advanced-content { display: none; }

        /* Print */
        @media print {
            .inventory-section, .controls-bar, h1.main-title, .modal, #setup-screen, .cell-delete-btn, .edit-color-btn, .add-item-btn { display: none !important; }
            #app-screen { display: block !important; }
            .single-child-table { 
                box-shadow: none !important; page-break-inside: avoid; margin-bottom: 20px; 
                border: 2px solid #ccc; width: 100% !important; min-width: 0 !important;
            }
            .week-grid { border: none; }
            body { background: white; padding: 0; }
            .day-cell { border: 1px solid #ddd !important; }
        }
    </style>
</head>
<body>

    <h1 class="main-title">×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™ ğŸ±</h1>
    <div style="position: absolute; top: 5px; left: 5px; font-size: 10px; color: #aaa;">v51.0</div>

    <div id="setup-screen">
        <h2>×”×’×“×¨×ª ×™×œ×“×™× ğŸ¨</h2>
        <div id="children-list-container"></div>
        <button class="btn btn-add" onclick="addChildRow()">+ ×”×•×¡×£ ×™×œ×“</button>
        <br><br>
        <button class="btn btn-primary" style="width: 100%; font-size: 18px; padding: 12px;" onclick="startApp()">×”×ª×—×œ ×œ×¢×¦×‘! ğŸš€</button>
    </div>

    <div id="app-screen">
        <div class="controls-bar">
            <div class="controls-group">
                <button class="btn btn-shopping" onclick="showShoppingList()">ğŸ›’ ×¨×©×™××”</button>
                <button class="btn btn-success" onclick="window.print()">ğŸ“¸ ×©××•×¨/×”×“×¤×¡</button>
                <button class="btn btn-magic" onclick="autoFillMenu()">ğŸª„ ××•×˜×•××˜×™ (×œ×¨×™×§)</button>
            </div>
            <button class="btn btn-warning" style="flex:0;" onclick="clearTable()">ğŸ§¹ × ×§×” ×”×›×œ</button>
        </div>

        <div class="inventory-section">
            <div class="tab-buttons"></div>
            <div id="inventory-list" class="inventory-list"></div>
        </div>

        <div id="tables-container"></div>
    </div>

    <div id="new-item-modal" class="modal">
        <div class="modal-content">
            <h3 style="color:var(--primary); margin-top:0;">×”×•×¡×¤×ª ×××›×œ ×—×“×©</h3>
            
            <div class="form-group">
                <label>×©× ×”×××›×œ:</label>
                <input type="text" id="modal-food-name" placeholder="×œ××©×œ: ×¡×•×©×™">
            </div>
            <div class="form-group">
                <label>×§×˜×’×•×¨×™×”:</label>
                <select id="modal-food-cat"></select>
            </div>

            <div class="form-group">
                <label>×‘×—×¨ ××™×™×§×•×Ÿ:</label>
                <div id="emoji-picker-container" class="emoji-picker"></div>
            </div>

            <button class="btn btn-primary" style="width:100%; margin: 15px 0; font-size:16px;" onclick="addNewItemFromModal()">â• ×”×•×¡×£ ×××›×œ ×œ××—×¡×Ÿ</button>

            <div class="advanced-section">
                <div class="advanced-toggle" onclick="toggleAdvanced()">×œ× ××¦××ª ××™××•×’'×™? ×—×¤×© ×ª××•× ×” ×‘×’×•×’×œ</div>
                <div id="advanced-content" class="advanced-content">
                    <button class="btn btn-google" onclick="searchGoogleImages()">ğŸ” ×—×¤×© ×ª××•× ×” ×‘×’×•×’×œ (× ×¤×ª×— ×‘×—×œ×•×Ÿ ×—×“×©)</button>
                    <div style="font-size:11px; color:#666; margin-bottom:5px;">×™×© ×œ×”×¢×ª×™×§ ××ª ×›×ª×•×‘×ª ×”×ª××•× ×” ×•×œ×”×“×‘×™×§ ×›××Ÿ:</div>
                    <input type="text" id="modal-food-url" placeholder="×”×“×‘×§ ×§×™×©×•×¨ ×œ×ª××•× ×” ×›××Ÿ..." style="width:100%; padding:8px; border:1px solid #ddd; border-radius:6px;">
                </div>
            </div>

            <button class="btn btn-warning" style="width:100%; margin-top:10px;" onclick="closeModal('new-item-modal')">×‘×™×˜×•×œ</button>
        </div>
    </div>

    <div id="shopping-modal" class="modal">
        <div class="modal-content">
            <h3>×¨×©×™××ª ×§× ×™×•×ª ğŸ“</h3>
            <div id="shopping-list-items" style="text-align:right; margin-bottom:15px;"></div>
            <button class="btn btn-primary" style="width:100%" onclick="closeModal('shopping-modal')">×¡×’×•×¨</button>
        </div>
    </div>

    <script>
        // --- Data ---
        const categories = [
            { id: 'bread', name: '×¤×—××™××”', icon: 'ğŸ' },
            { id: 'filling', name: '×—×œ×‘×•×Ÿ/×××¨×—', icon: 'ğŸ§€' }, 
            { id: 'veggie', name: '×™×¨×§', icon: 'ğŸ¥’' },
            { id: 'fruit', name: '×¤×¨×™', icon: 'ğŸ' },
            { id: 'treat', name: '×¤×™× ×•×§', icon: 'ğŸª' }
        ];
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™'];
        
        const commonEmojis = ['ğŸ¥ª','ğŸ','ğŸ¥¯','ğŸ¥','ğŸ¥–','ğŸ¥¨','ğŸ¥','ğŸ§‡','ğŸ§€','ğŸ¥š','ğŸ³','ğŸ—','ğŸ–','ğŸ¥©','ğŸŒ­','ğŸ”','ğŸŸ','ğŸ•','ğŸŒ®','ğŸŒ¯','ğŸ¥—','ğŸ¥£','ğŸ¥’','ğŸ…','ğŸ¥‘','ğŸ¥¦','ğŸ¥•','ğŸŒ½','ğŸ«‘','ğŸ¥”','ğŸ ','ğŸ§…','ğŸ§„','ğŸ','ğŸ','ğŸŠ','ğŸ‹','ğŸŒ','ğŸ‰','ğŸ‡','ğŸ“','ğŸ«','ğŸˆ','ğŸ’','ğŸ‘','ğŸ¥­','ğŸ','ğŸ¥¥','ğŸ¥','ğŸª','ğŸ©','ğŸ«','ğŸ¬','ğŸ­','ğŸ®','ğŸ§','ğŸ°','ğŸ¦','ğŸ¨','ğŸ¥›','ğŸ§ƒ','ğŸ¥¤','ğŸµ'];

        const iconDictionary = {
            '×œ×—×× ×™×”': 'ğŸ¥–', '×œ×—× ××œ×': 'ğŸ', '×¤×™×ª×”': 'ğŸ¥™', '×‘×™×™×’×œ×”': 'ğŸ¥¨', '×œ×—×': 'ğŸ', '×˜×•×¡×˜': 'ğŸ¥ª',
            '×××¨×— ×©×•×§×•×œ×“': 'ğŸ«', '×‘×™×¦×” ×§×©×”': 'ğŸ¥š', '×¤×¡×˜×¨××”': 'ğŸ¥©', '×’×‘×™× ×” ×¦×”×•×‘×”': 'ğŸ§€', '×§×•×˜×’': 'ğŸš',
            '×ª×•×ª×™×': 'ğŸ“', '×ª×¤×•×—': 'ğŸ', '××•×›×× ×™×•×ª': 'ğŸ«', '×‘× × ×”': 'ğŸŒ', '×¢× ×‘×™×': 'ğŸ‡', '××’×¡': 'ğŸ',
            '××œ×¤×¤×•×Ÿ': 'ğŸ¥’', '×¢×’×‘× ×™×•×ª ×©×¨×™': 'ğŸ…', '×¤×œ×¤×œ ×’××‘×”': 'ğŸ«‘', '×’×–×¨': 'ğŸ¥•', '×–×™×ª×™×': 'ğŸ«’',
            '×™×•×’×•×¨×˜': 'ğŸ¥›', '×¤×ª×™ ×‘×¨': 'ğŸª', '×—×˜×™×£': 'ğŸ¬', '××§×˜×™××œ': { type: 'img', src: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/25/Actimel_classic.jpg/440px-Actimel_classic.jpg' }
        };

        let allInventoryItems = [
            { name: '×œ×—×× ×™×”', cat: 'bread' }, { name: '×¤×™×ª×”', cat: 'bread' }, { name: '×˜×•×¡×˜', cat: 'bread' }, { name: '×‘×™×™×’×œ×”', cat: 'bread' },
            { name: '×’×‘×™× ×” ×¦×”×•×‘×”', cat: 'filling' }, { name: '×‘×™×¦×” ×§×©×”', cat: 'filling' }, { name: '×××¨×— ×©×•×§×•×œ×“', cat: 'filling' }, { name: '×§×•×˜×’', cat: 'filling' },
            { name: '××œ×¤×¤×•×Ÿ', cat: 'veggie' }, { name: '×¢×’×‘× ×™×•×ª ×©×¨×™', cat: 'veggie' }, { name: '×’×–×¨', cat: 'veggie' }, { name: '×¤×œ×¤×œ ×’××‘×”', cat: 'veggie' },
            { name: '×ª×¤×•×—', cat: 'fruit' }, { name: '×‘× × ×”', cat: 'fruit' }, { name: '×¢× ×‘×™×', cat: 'fruit' }, { name: '×ª×•×ª×™×', cat: 'fruit' },
            { name: '×™×•×’×•×¨×˜', cat: 'treat' }, { name: '×¤×ª×™ ×‘×¨', cat: 'treat' }, { name: '××§×˜×™××œ', cat: 'treat' }, { name: '×—×˜×™×£', cat: 'treat' }
        ];

        let childrenData = [];
        let selectedInventoryItem = null;
        let selectedEmoji = null;

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            populateCatSelect();
            populateEmojiPicker();
            if(document.getElementById('children-list-container').children.length === 0) addChildRow('×™×œ×“/×” 1', '#6c5ce7');
        });

        function populateCatSelect() {
            const s = document.getElementById('modal-food-cat');
            s.innerHTML = '';
            categories.forEach(c => {
                const o = document.createElement('option');
                o.value = c.id; o.innerText = c.name;
                s.appendChild(o);
            });
        }

        function populateEmojiPicker() {
            const c = document.getElementById('emoji-picker-container');
            c.innerHTML = '';
            commonEmojis.forEach(e => {
                const sp = document.createElement('span');
                sp.className = 'emoji-option';
                sp.innerText = e;
                sp.onclick = () => {
                    document.querySelectorAll('.emoji-option').forEach(x => x.classList.remove('selected'));
                    sp.classList.add('selected');
                    selectedEmoji = e;
                    document.getElementById('modal-food-url').value = ''; // Clear URL if emoji selected
                };
                c.appendChild(sp);
            });
        }

        // --- Setup Logic ---
        window.addChildRow = function(name = '', color = '#a29bfe') {
            const container = document.getElementById('children-list-container');
            const div = document.createElement('div');
            div.className = 'child-input-row';
            const showRemove = container.children.length > 0 || name === '';
            div.innerHTML = `
                <input type="text" placeholder="×©× ×”×™×œ×“/×”" value="${name}">
                <div class="color-picker-wrapper" title="×‘×—×¨ ×¦×‘×¢">
                    <input type="color" value="${color}" onchange="this.parentElement.style.backgroundColor = this.value">
                </div>
                ${showRemove ? '<button class="remove-row-btn" onclick="this.parentElement.remove()">x</button>' : ''}
            `;
            // Set initial BG color for picker wrapper
            div.querySelector('.color-picker-wrapper').style.backgroundColor = color;
            
            container.appendChild(div);

            // FOCUS LOGIC (Requested)
            const input = div.querySelector('input[type="text"]');
            if(input) input.focus();
        }

        window.startApp = function() {
            childrenData = [];
            document.querySelectorAll('.child-input-row').forEach(row => {
                const name = row.querySelector('input[type="text"]').value.trim();
                const color = row.querySelector('input[type="color"]').value;
                if(name) childrenData.push({ name, color });
            });

            if(childrenData.length === 0) return alert('× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×™×œ×“ ××—×“');

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            
            initInventoryTabs();
            initInventory('bread');
            buildTables();
        }

        // --- Core Logic ---
        function resolveIcon(item) {
            if(item.customUrl) {
                 if(item.customUrl.startsWith('http')) return `<img src="${item.customUrl}">`;
                 return `<span class="emoji">${item.customUrl}</span>`;
            }
            const val = iconDictionary[item.name];
            if(val) {
                if(typeof val === 'object') return `<img src="${val.src}">`;
                return `<span class="emoji">${val}</span>`;
            }
            return `<span class="emoji">ğŸ±</span>`;
        }

        function initInventoryTabs() {
            const c = document.querySelector('.tab-buttons');
            c.innerHTML = '';
            categories.forEach((cat, idx) => {
                const b = document.createElement('div');
                b.className = `tab-button ${idx===0?'active':''}`;
                b.innerText = `${cat.icon} ${cat.name}`;
                b.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(x=>x.classList.remove('active'));
                    b.classList.add('active');
                    initInventory(cat.id);
                };
                c.appendChild(b);
            });
        }

        function initInventory(catId) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            selectedInventoryItem = null;

            // Items
            allInventoryItems.filter(i => i.cat === catId).forEach(item => {
                const el = document.createElement('div');
                el.className = 'food-item';
                el.innerHTML = resolveIcon(item) + `<span>${item.name}</span>`;
                el.onclick = () => {
                    if(selectedInventoryItem === item) {
                        selectedInventoryItem = null;
                        el.classList.remove('selected-for-move');
                    } else {
                        document.querySelectorAll('.inventory-list .food-item').forEach(x=>x.classList.remove('selected-for-move'));
                        selectedInventoryItem = item;
                        el.classList.add('selected-for-move');
                    }
                };
                list.appendChild(el);
            });

            // Add Button
            const addBtn = document.createElement('div');
            addBtn.className = 'food-item add-item-btn';
            addBtn.innerText = '+';
            addBtn.onclick = () => openAddModal(catId);
            list.appendChild(addBtn);
        }

        function hexToRgba(hex, alpha) {
            let r=0,g=0,b=0;
            if(hex.length===4){r="0x"+hex[1]+hex[1];g="0x"+hex[2]+hex[2];b="0x"+hex[3]+hex[3];}
            else if(hex.length===7){r="0x"+hex[1]+hex[2];g="0x"+hex[3]+hex[4];b="0x"+hex[5]+hex[6];}
            return `rgba(${+r},${+g},${+b},${alpha})`;
        }

        function buildTables() {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';
            
            childrenData.forEach((child, index) => {
                const card = document.createElement('div');
                card.className = 'single-child-table';
                card.id = `child-card-${index}`;
                
                // Header with Color Edit
                card.innerHTML = `
                    <div class="child-title" style="background:${child.color}">
                        <span>${child.name}</span>
                        <div class="edit-color-btn" title="×©× ×” ×¦×‘×¢">
                            ğŸ¨
                            <input type="color" value="${child.color}" onchange="updateChildColor(${index}, this.value)">
                        </div>
                    </div>`;

                const grid = document.createElement('div');
                grid.className = 'week-grid';
                grid.style.backgroundColor = hexToRgba(child.color, 0.2);
                grid.id = `grid-${index}`;

                // Header Row
                grid.appendChild(createHeader('×§×˜×’×•×¨×™×”'));
                days.forEach(d => {
                     const h = createHeader(d);
                     h.classList.add('day-header');
                     grid.appendChild(h);
                });

                // Body
                categories.forEach(cat => {
                    const rowHeader = createHeader(cat.name + ' ' + cat.icon);
                    grid.appendChild(rowHeader);

                    days.forEach(day => {
                        const cell = document.createElement('div');
                        cell.className = 'day-cell';
                        cell.dataset.cat = cat.id;
                        cell.onclick = () => {
                            if(selectedInventoryItem) {
                                if(selectedInventoryItem.cat !== cat.id && !confirm('×–×” ×œ× ××ª××™× ×œ×§×˜×’×•×¨×™×”. ×œ×”×•×¡×™×£?')) return;
                                fillCell(cell, selectedInventoryItem);
                                selectedInventoryItem = null;
                                document.querySelectorAll('.selected-for-move').forEach(x=>x.classList.remove('selected-for-move'));
                            }
                        };
                        grid.appendChild(cell);
                    });
                });

                card.appendChild(grid);
                container.appendChild(card);
            });
        }

        function createHeader(text) {
            const d = document.createElement('div');
            d.className = 'header-cell';
            d.innerText = text;
            return d;
        }

        // --- NEW: Update Color Logic ---
        window.updateChildColor = function(index, newColor) {
            childrenData[index].color = newColor;
            
            // Update DOM directly without rebuilding to keep data
            const card = document.getElementById(`child-card-${index}`);
            const title = card.querySelector('.child-title');
            const grid = document.getElementById(`grid-${index}`);
            
            title.style.background = newColor;
            grid.style.backgroundColor = hexToRgba(newColor, 0.2);
        }

        function fillCell(cell, item) {
            cell.innerHTML = '';
            if(!item) {
                cell.classList.remove('filled');
                return;
            }
            cell.classList.add('filled');
            const content = document.createElement('div');
            content.className = 'food-item';
            content.style.border = 'none'; 
            content.style.background = 'transparent';
            content.style.width = '100%'; 
            content.style.height = '100%';
            content.innerHTML = resolveIcon(item) + `<span>${item.name}</span>`;
            
            const del = document.createElement('div');
            del.className = 'cell-delete-btn';
            del.innerText = 'x';
            del.onclick = (e) => { e.stopPropagation(); fillCell(cell, null); };

            cell.appendChild(content);
            cell.appendChild(del);
        }

        // --- Modal & Features Logic ---

        window.openAddModal = function(catId) {
            document.getElementById('modal-food-name').value = '';
            document.getElementById('modal-food-cat').value = catId;
            document.getElementById('modal-food-url').value = '';
            selectedEmoji = null;
            document.querySelectorAll('.emoji-option').forEach(x => x.classList.remove('selected'));
            
            // Reset Advanced View
            document.getElementById('advanced-content').style.display = 'none';
            document.querySelector('.advanced-toggle').style.display = 'block';

            document.getElementById('new-item-modal').style.display = 'flex';
        }

        window.toggleAdvanced = function() {
            document.getElementById('advanced-content').style.display = 'block';
            document.querySelector('.advanced-toggle').style.display = 'none';
        }

        window.searchGoogleImages = function() {
            const name = document.getElementById('modal-food-name').value;
            if(!name) return alert('×”×›× ×¡ ×©× ×××›×œ ×§×•×“× ×›×“×™ ×©× ×—×¤×© ××•×ª×•');
            window.open(`https://www.google.com/search?tbm=isch&q=${encodeURIComponent(name)}`, '_blank');
        }

        window.addNewItemFromModal = function() {
            const name = document.getElementById('modal-food-name').value.trim();
            const cat = document.getElementById('modal-food-cat').value;
            const urlInput = document.getElementById('modal-food-url').value.trim();
            
            if(!name) return alert('× × ×œ×”×–×™×Ÿ ×©×');
            
            // Priority: URL > Emoji > Default
            let finalUrl = null;
            if(urlInput) finalUrl = urlInput;
            else if(selectedEmoji) finalUrl = selectedEmoji;

            allInventoryItems.push({ name, cat, customUrl: finalUrl });
            closeModal('new-item-modal');
            
            // Refresh current tab if needed
            const activeTab = document.querySelector('.tab-button.active');
            if(activeTab && activeTab.innerText.includes(categories.find(c=>c.id===cat).name)) {
                initInventory(cat);
            } else {
                // Switch to that tab
                const allTabs = document.querySelectorAll('.tab-button');
                const targetIdx = categories.findIndex(c=>c.id===cat);
                allTabs[targetIdx].click();
            }
        }

        window.autoFillMenu = function() {
            // Smart Auto Fill: Only empty cells
            document.querySelectorAll('.day-cell').forEach(cell => {
                if(cell.classList.contains('filled')) return; // Skip if full

                const catId = cell.dataset.cat;
                const available = allInventoryItems.filter(i => i.cat === catId);
                if(available.length > 0) {
                    const rand = available[Math.floor(Math.random() * available.length)];
                    fillCell(cell, rand);
                }
            });
        }

        window.clearTable = function() {
            if(confirm('×œ× ×§×•×ª ××ª ×›×œ ×”×œ×•×—×•×ª?')) {
                document.querySelectorAll('.day-cell').forEach(c => fillCell(c, null));
            }
        }

        window.showShoppingList = function() {
            const counts = {};
            document.querySelectorAll('.day-cell.filled').forEach(cell => {
                const name = cell.querySelector('span:not(.emoji)').innerText;
                counts[name] = (counts[name] || 0) + 1;
            });

            let html = '';
            if(Object.keys(counts).length === 0) html = '×”×œ×•×— ×¨×™×§...';
            else {
                for(let [k,v] of Object.entries(counts)) {
                    html += `<div><b>${k}:</b> ${v}</div>`;
                }
            }
            document.getElementById('shopping-list-items').innerHTML = html;
            document.getElementById('shopping-modal').style.display = 'flex';
        }

        window.closeModal = function(id) { document.getElementById(id).style.display = 'none'; }
    </script>
</body>
</html>
