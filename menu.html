<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™</title>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Rubik:wght@300;400;500;700&display=swap');

        :root {
            --bg-color: #f0f3f7;
            --accent: #ff7675;
            --primary: #6c5ce7;
            --text: #2d3436;
            --shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        body {
            font-family: 'Rubik', sans-serif;
            background-color: var(--bg-color);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1.main-title {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 32px;
            text-align: center;
        }

        /* --- UI Elements --- */
        .btn {
            border: none;
            padding: 10px 15px;
            border-radius: 12px;
            font-size: 14px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
        .btn-primary { background: var(--primary); }
        .btn-success { background: #00b894; }
        .btn-warning { background: #fdcb6e; color: #333; }
        .btn-shopping { background: #e17055; }
        .btn-magic { background: linear-gradient(135deg, #a29bfe, #74b9ff); }
        .btn-whatsapp { background: #25d366; }
        .btn-add { background: #fab1a0; color: #333; margin-top: 10px; width: 100%; }
        .btn-small-delete { background: #ff7675; color: white; padding: 5px 8px; font-size: 12px; border-radius: 8px; }

        /* --- Setup Screen --- */
        #setup-screen {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: var(--shadow);
            text-align: center;
            max-width: 450px;
            width: 100%;
            margin-top: 10px;
        }

        .child-input-row { display: flex; gap: 10px; margin-bottom: 10px; align-items: center; }
        .child-input-row input[type="text"] { flex: 1; padding: 10px; border: 2px solid #dfe6e9; border-radius: 10px; outline: none; font-family: 'Rubik', sans-serif; }
        .child-input-row input[type="color"] { width: 40px; height: 40px; border: none; background: none; cursor: pointer; }
        .remove-row-btn { background: #ff7675; color: white; border: none; border-radius: 50%; width: 25px; height: 25px; cursor: pointer; font-weight: bold; }

        /* --- Main App --- */
        #app-screen { display: none; width: 100%; max-width: 1200px; flex-direction: column; gap: 20px; margin-bottom: 80px; }
        .controls-bar { background: white; padding: 15px; border-radius: 15px; display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; gap: 10px; box-shadow: var(--shadow); position: sticky; top: 10px; z-index: 100; }
        
        /* Inventory */
        .inventory-section { background: white; padding: 15px; border-radius: 15px; box-shadow: var(--shadow); }
        .tab-buttons { display: flex; justify-content: center; gap: 5px; margin-bottom: 15px; flex-wrap: wrap; }
        .tab-button { background: #dfe6e9; padding: 8px 15px; border-radius: 10px; cursor: pointer; font-weight: 500; color: #555; transition: background 0.2s; }
        .tab-button.active { background: var(--primary); color: white; }

        .new-item-control {
            display: flex;
            gap: 10px;
            justify-content: center;
            align-items: center;
            margin-bottom: 15px;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 12px;
        }
        .new-item-control input { flex: 2; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Rubik', sans-serif; }
        .new-item-control select { flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ccc; font-family: 'Rubik', sans-serif; cursor: pointer; }
        .new-item-control button { width: 50px; font-size: 20px; padding: 5px; }

        .inventory-list { display: flex; flex-wrap: wrap; gap: 8px; justify-content: center; max-height: 150px; overflow-y: auto; padding-bottom: 5px; }

        /* Draggable Items */
        .food-item {
            width: 70px;
            height: 70px;
            background: white;
            border: 1px solid #dfe6e9;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: grab;
            user-select: none;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            font-size: 11px;
            text-align: center;
            line-height: 1.1;
            position: relative;
            overflow: hidden;
        }
        .food-item:hover { border-color: var(--primary); transform: scale(1.05); }
        .food-item img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 2px; }
        .food-item span.emoji { font-size: 28px; margin-bottom: 4px; display: block; }
        
        .food-item[data-cat="bread"] { border-top: 3px solid #fdcb6e; }
        .food-item[data-cat="filling"] { border-top: 3px solid #ff7675; }
        .food-item[data-cat="veggie"] { border-top: 3px solid #00b894; }
        .food-item[data-cat="fruit"] { border-top: 3px solid #e17055; }
        .food-item[data-cat="treat"] { border-top: 3px solid #a29bfe; }

        /* Context Menu & Modals */
        #context-menu { display: none; position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.2); z-index: 3000; overflow: hidden; }
        .ctx-item { padding: 10px 20px; cursor: pointer; font-size: 14px; }
        .ctx-item:hover { background: #f0f0f0; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 400px; max-height: 90vh; overflow-y: auto; }
        
        /* Selector List */
        #item-selector-list { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; max-height: 40vh; overflow-y: auto; padding: 10px; border: 1px solid #eee; border-radius: 10px; }
        #item-selector-list .food-item { cursor: pointer; width: 80px; height: 80px; }
        #item-selector-list .food-item:hover { border-color: var(--accent); transform: scale(1.05); }

        /* Tables */
        .single-child-table { background: white; padding: 25px; border-radius: 20px; box-shadow: var(--shadow); page-break-inside: avoid; page-break-after: always; }
        .child-title { text-align: center; font-size: 24px; font-weight: bold; margin-bottom: 15px; padding: 10px; border-radius: 10px; color: #fff; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .week-grid { display: grid; grid-template-columns: 80px repeat(6, 1fr); gap: 5px; border: 1px solid rgba(0,0,0,0.1); padding: 8px; border-radius: 12px; }
        .header-cell { padding: 8px; text-align: center; font-weight: bold; border-radius: 6px; font-size: 13px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.6); }
        .day-header { background: #ffeaa7 !important; }

        .day-cell {
            background: rgba(255,255,255,0.5); 
            border-radius: 6px;
            min-height: 70px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 1px dashed rgba(0,0,0,0.2);
            cursor: pointer;
            position: relative;
            padding: 5px;
        }

        .day-cell .food-item { width: 100%; height: auto; min-height: 60px; margin: 0; cursor: grab; box-shadow: none; border: none; border-radius: 0; }
        
        .cell-menu-btn {
            position: absolute; top: 2px; right: 2px;
            background: rgba(0,0,0,0.1); border: none; border-radius: 50%; width: 18px; height: 18px;
            font-size: 12px; line-height: 18px; text-align: center; cursor: pointer; color: #333; padding: 0; display: none;
        }
        .day-cell:hover .cell-menu-btn { display: block; }
        .day-cell.filled .cell-menu-btn { background: #ff7675; color: white; }

        /* Shopping List */
        .shopping-item { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; font-size: 18px; }
        .shopping-item .icon-and-name { display: flex; align-items: center; gap: 8px; }
        .shopping-item .icon-and-name img, .shopping-item .icon-and-name .emoji { width: 24px; height: 24px; font-size: 20px; }

        #trash-can { position: fixed; bottom: 20px; left: 20px; width: 70px; height: 70px; background: #ff7675; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; box-shadow: var(--shadow); z-index: 1000; }
        
        /* --- PRINT OPTIMIZATION (A4 Landscape) --- */
        @media print {
            @page {
                size: landscape; /* A4 Landscape */
                margin: 0;
            }
            body {
                background: white;
                padding: 0;
                margin: 0;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
                width: 100vw;
                height: 100vh;
            }
            /* Hide UI Elements */
            .inventory-section, #trash-can, .controls-bar, .new-item-control, h1.main-title, .modal, .cell-menu-btn, #setup-screen { 
                display: none !important; 
            }
            
            /* Expand Table to Fill Page */
            #tables-container {
                display: block;
                width: 100%;
            }
            
            .single-child-table {
                width: 100vw;
                height: 100vh;
                box-shadow: none;
                border: none;
                margin: 0;
                padding: 10px 20px;
                box-sizing: border-box;
                page-break-after: always; /* Each child on new page */
                display: flex;
                flex-direction: column;
            }
            
            .child-title {
                font-size: 30px;
                padding: 10px;
                margin-bottom: 10px;
            }

            .week-grid {
                flex: 1; /* Take remaining height */
                display: grid;
                grid-template-columns: 100px repeat(6, 1fr); /* Slightly wider row header */
                grid-template-rows: 50px repeat(5, 1fr); /* Fixed header height, equal row heights */
                gap: 2px;
                border: 2px solid #ccc;
            }

            .header-cell {
                font-size: 16px;
                background-color: #eee !important;
                border: 1px solid #999;
            }
            
            .day-cell {
                border: 1px solid #999;
                min-height: 0; /* Let grid control height */
            }
            
            /* Make icons bigger in print */
            .day-cell .food-item img, .day-cell .food-item span.emoji {
                width: 60px;
                height: 60px;
                font-size: 50px;
            }
            .day-cell .food-item span:not(.emoji) {
                font-size: 16px; /* Text label size */
                font-weight: bold;
            }
        }
    </style>
</head>
<body>

    <h1 class="main-title">×ª×¤×¨×™×˜ ×§×•×¤×¡××•×ª ×©×‘×•×¢×™</h1>

    <div id="setup-screen">
        <h2>×”×’×“×¨×ª ×§×•×¤×¡××•×ª ××•×›×œ ğŸ¨</h2>
        <p>×”×•×¡×™×¤×• ×™×œ×“×™× ×•×‘×—×¨×• ×¦×‘×¢ ×œ×§×•×¤×¡×” ×©×œ×”×:</p>
        <div id="children-list-container"></div>
        <button class="btn btn-add" onclick="addChildRow()">+ ×”×•×¡×£ ×™×œ×“</button>
        <br><br>
        <button class="btn btn-primary" style="width: 100%; justify-content: center; padding: 12px;" onclick="startApp()">×”×ª×—×œ ×œ×¢×¦×‘! ğŸš€</button>
    </div>

    <div id="app-screen">
        <div class="controls-bar">
            <div style="display:flex; gap:10px; flex-wrap: wrap;">
                <button class="btn btn-shopping" onclick="showShoppingList()">ğŸ›’ ×¨×©×™××ª ×§× ×™×•×ª</button>
                <button class="btn btn-success" onclick="window.print()">ğŸ“¸ ×©××•×¨ (PDF)</button>
                <button class="btn btn-magic" onclick="autoFillMenu()">ğŸª„ ××•×˜×•××˜×™</button>
            </div>
            <button class="btn btn-warning" onclick="clearTable()">ğŸ§¹ × ×§×”</button>
        </div>

        <div class="inventory-section">
            <h4 style="margin:0 0 10px 0; text-align:center;">××—×¡×Ÿ ××•×¦×¨×™× (×§×œ×™×§ ×™×× ×™ ×œ×¢×¨×™×›×ª ×ª××•× ×”)</h4>
            <div class="tab-buttons"></div>
            
            <div class="new-item-control">
                <input type="text" id="new-food-name" placeholder="×”×§×œ×“ ×©× ×××›×œ (×œ××©×œ: ×‘×•×¨×§×¡)..." onkeypress="handleKeyPress(event)">
                <select id="new-food-cat" title="×‘×—×¨ ×§×˜×’×•×¨×™×”">
                    <option value="auto">âœ¨ ×–×™×”×•×™ ××•×˜×•××˜×™</option>
                </select>
                <button class="btn btn-primary" onclick="addNewItem()">+</button>
            </div>

            <div id="inventory-list" class="inventory-list"></div>
        </div>

        <div id="tables-container"></div>
    </div>

    <div id="item-selector-modal" class="modal">
        <div class="modal-content">
            <h2 id="selector-title" style="text-align:center; color:#6c5ce7;">×‘×—×™×¨×ª ×¤×¨×™×˜ </h2>
            <div id="item-selector-list"></div>
            <br>
            <div style="display: flex; gap: 10px;">
                 <button class="btn btn-small-delete" style="flex: 1;" onclick="deleteItemFromCell()">ğŸ—‘ï¸ ××—×§ ×¤×¨×™×˜ ×§×™×™×</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('item-selector-modal').style.display='none'">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <div id="context-menu">
        <div class="ctx-item" onclick="changeItemImage()">ğŸ–¼ï¸ ×©× ×” ×ª××•× ×” (URL)</div>
        <div class="ctx-item" onclick="deleteItemFromInventory()" style="color:red">ğŸ—‘ï¸ ××—×§ ××”××—×¡×Ÿ</div>
    </div>

    <div id="shopping-modal" class="modal">
        <div class="modal-content">
            <h2 style="text-align:center; color:#6c5ce7;">×¨×©×™××ª ×§× ×™×•×ª ğŸ“</h2>
            <div id="shopping-list-items"></div>
            <br>
            <div style="display: flex; gap: 10px;">
                <button class="btn btn-whatsapp" style="flex: 1;" onclick="copyToWhatsapp()">ğŸ’¬ ×”×¢×ª×§ ×œ×•×•××˜×¡××¤</button>
                <button class="btn btn-primary" style="flex: 1;" onclick="document.getElementById('shopping-modal').style.display='none'">×¡×’×•×¨</button>
            </div>
        </div>
    </div>

    <div id="trash-can" ondrop="trashDrop(event)" ondragover="allowDrop(event)">
        <span style="font-size:30px;">ğŸ—‘ï¸</span>
    </div>

    <script>
        // --- Global Data & State ---
        let childrenData = []; 
        let contextTargetItem = null;
        let shoppingListSummary = {};
        let currentCellTarget = null; 

        const categories = [
            { id: 'bread', name: '×¤×—××™××”', icon: 'ğŸ' },
            { id: 'filling', name: '×—×œ×‘×•×Ÿ/×××¨×—', icon: 'ğŸ§€' },
            { id: 'veggie', name: '×™×¨×§', icon: 'ğŸ¥’' },
            { id: 'fruit', name: '×¤×¨×™', icon: 'ğŸ' },
            { id: 'treat', name: '×¤×™× ×•×§', icon: 'ğŸª' }
        ];
        const days = ['×¨××©×•×Ÿ', '×©× ×™', '×©×œ×™×©×™', '×¨×‘×™×¢×™', '×—××™×©×™', '×©×™×©×™'];
        
        // Dictionary matching the items in the uploaded image + New items
        const iconDictionary = {
            // Row 1: Breads
            '×œ×—×× ×™×”': 'ğŸ¥–',
            '×¤× ×§×™×™×§': 'ğŸ¥', 
            '×œ×—× ××œ×': 'ğŸ',
            '×¤×™×ª×”': 'ğŸ¥™',
            '×‘×™×™×’×œ×”': 'ğŸ¥¨',
            '×œ×—×': 'ğŸ',
            '×˜×•×¡×˜': 'ğŸ¥ª',
            '×‘×œ×™× ×¦×¡': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmtCm9Bu4wczi_0LUyr29ux-xOfFnzeLq_6bvycZPmBA&s=10' },
            
            // Row 2: Proteins
            '×××¨×— ×©×•×§×•×œ×“': 'ğŸ«',
            '×‘×™×¦×” ×§×©×”': 'ğŸ¥š',
            '×—×‘×™×ª×”': 'ğŸ³',
            '×¤×¡×˜×¨××”': 'ğŸ¥©',
            '×’×‘×™× ×” ×œ×‘× ×”': { type: 'img', src: 'https://noyhasade.b-cdn.net/wp-content/uploads/2020/09/7290002824183-2.jpg'},
            '×’×‘×™× ×” ×¦×”×•×‘×”': 'ğŸ§€',
            '×‘×•×œ×’×¨×™×ª': { type: 'img', src: 'https://gad-dairy.co.il/wp-content/uploads/2016/05/30056-13-a_pic_site_9-1024x1024.png' },
            '×’×‘×™× ×ª ×©×× ×ª': { type: 'img', src: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcTtiZ7V4aeVC52RnVhqm5FHQpxuQ8wk182azK07MmJ9Rg&s=10' },
            
            // Row 3: Fruits
            '×ª×•×ª×™×': 'ğŸ“',
            '×ª×¤×•×—': 'ğŸ',
            '××•×›×× ×™×•×ª': 'ğŸ«',
            '×©×–×™×£': 'ğŸŸ£', // Closest emoji
            '×× ×’×•': 'ğŸ¥­',
            '×§×™×•×•×™': 'ğŸ¥',
            '×‘× × ×”': 'ğŸŒ',
            
            // Row 4: Veggies + Fruit (from image)
            '×ª×¤×•': 'ğŸŠ', // Orange (named Tapuz in hebrew)
            '×–×™×ª×™× ×™×¨×•×§×™×': 'ğŸ«’',
            '××œ×¤×¤×•×Ÿ': 'ğŸ¥’',
            '××œ×¤×¤×•×Ÿ ×—××•×¥': 'ğŸ¥’',
            '×¢×’×‘× ×™×•×ª ×©×¨×™': 'ğŸ…',
            '×¤×œ×¤×œ ×’××‘×”': 'ğŸ«‘',
            '×¢×’×‘× ×™×”': 'ğŸ…',
            
            // Row 5: Treats
            '×§×¨×§×¨×™×': { type: 'img', src: 'https://st1.foodsd.co.il/Images/Products/large/Yz1gR9k5ej75oC8J.jpg' },
            '×™×•×’×•×¨×˜': 'ğŸ¥›',
            '×¤×ª×™ ×‘×¨': 'ğŸª',
            '××™×¥ ×ª×¤×•×–×™×': 'ğŸ§ƒ',
            '×§××¤×§×™×™×§': 'ğŸ§',
            '×‘×™×™×’×œ×” (×—×˜×™×£)': 'ğŸ¥¨',
            '×—×˜×™×£': 'ğŸ¬',
            '××§×˜×™××œ': { type: 'img', src: 'https://www.emess.co.il/resize/?width=800&height=450&url=/uploads/2024/08/%D7%90%D7%A7%D7%98%D7%99%D7%9E%D7%9C.jpg' },
            '×›×“×•×¨ ×©×•×§×•×œ×“': { type: 'img', src: 'https://cakenet.co.il/wp-content/uploads/2019/02/0_02891.jpg' },
            
            // Defaults
            'bread': 'ğŸ', 'filling': 'ğŸ§€', 'veggie': 'ğŸ¥’', 'fruit': 'ğŸ', 'treat': 'ğŸª' 
        };

        // Inventory
        let allInventoryItems = [
            // Breads
            { name: '×œ×—×× ×™×”', cat: 'bread' }, { name: '×¤× ×§×™×™×§', cat: 'bread' }, { name: '×œ×—× ××œ×', cat: 'bread' }, { name: '×¤×™×ª×”', cat: 'bread' }, { name: '×‘×™×™×’×œ×”', cat: 'bread' }, { name: '×œ×—×', cat: 'bread' }, { name: '×‘×œ×™× ×¦×¡', cat: 'bread' },
            // Filling
            { name: '×××¨×— ×©×•×§×•×œ×“', cat: 'filling' }, { name: '×‘×™×¦×” ×§×©×”', cat: 'filling' }, { name: '×—×‘×™×ª×”', cat: 'filling' }, { name: '×¤×¡×˜×¨××”', cat: 'filling' }, { name: '×’×‘×™× ×” ×œ×‘× ×”', cat: 'filling' }, { name: '×’×‘×™× ×” ×¦×”×•×‘×”', cat: 'filling' }, { name: '×‘×•×œ×’×¨×™×ª', cat: 'filling' }, { name: '×’×‘×™× ×ª ×©×× ×ª', cat: 'filling' },
            // Fruit
            { name: '×ª×•×ª×™×', cat: 'fruit' }, { name: '×ª×¤×•×—', cat: 'fruit' }, { name: '××•×›×× ×™×•×ª', cat: 'fruit' }, { name: '×©×–×™×£', cat: 'fruit' }, { name: '×× ×’×•', cat: 'fruit' }, { name: '×§×™×•×•×™', cat: 'fruit' },
            // Veggie
            { name: '×ª×¤×•', cat: 'veggie' }, { name: '×–×™×ª×™× ×™×¨×•×§×™×', cat: 'veggie' }, { name: '××œ×¤×¤×•×Ÿ', cat: 'veggie' }, { name: '××œ×¤×¤×•×Ÿ ×—××•×¥', cat: 'veggie' }, { name: '×¢×’×‘× ×™×•×ª ×©×¨×™', cat: 'veggie' }, { name: '×¤×œ×¤×œ ×’××‘×”', cat: 'veggie' },
            // Treats
            { name: '×§×¨×§×¨×™×', cat: 'treat' }, { name: '×™×•×’×•×¨×˜', cat: 'treat' }, { name: '×¤×ª×™ ×‘×¨', cat: 'treat' }, { name: '××™×¥ ×ª×¤×•×–×™×', cat: 'treat' }, { name: '×§××¤×§×™×™×§', cat: 'treat' }, { name: '×‘×™×™×’×œ×” (×—×˜×™×£)', cat: 'treat' },
            // Extras
            { name: '××§×˜×™××œ', cat: 'treat' }, { name: '×›×“×•×¨ ×©×•×§×•×œ×“', cat: 'treat' }
        ];

        // --- Setup Functions ---
        document.addEventListener('DOMContentLoaded', () => {
            const catSelect = document.getElementById('new-food-cat');
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat.id;
                option.innerText = `${cat.icon} ${cat.name}`;
                catSelect.appendChild(option);
            });
            if (document.getElementById('children-list-container').children.length === 0) {
                addChildRow('××•×¨×™' ,  '#539fec');
            }
        });

        function addChildRow(name = '', color = '#a29bfe') {
            const container = document.getElementById('children-list-container');
            const div = document.createElement('div');
            div.className = 'child-input-row';
            const canRemove = container.children.length > 0 || name === ''; 
            div.innerHTML = `
                <input type="text" placeholder="×©× ×”×™×œ×“/×”" value="${name}">
                <input type="color" value="${color}" title="×¦×‘×¢ ×”×§×•×¤×¡×”">
                ${canRemove ? '<button class="remove-row-btn" onclick="this.parentElement.remove()">x</button>' : ''}
            `;
            container.appendChild(div);
        }

        function startApp() {
            const rows = document.querySelectorAll('.child-input-row');
            childrenData = [];
            rows.forEach(row => {
                const name = row.querySelector('input[type="text"]').value.trim();
                const color = row.querySelector('input[type="color"]').value;
                if(name) childrenData.push({ name, color });
            });
            if (childrenData.length === 0) return alert('× × ×œ×”×•×¡×™×£ ×œ×¤×—×•×ª ×™×œ×“ ××—×“');

            document.getElementById('setup-screen').style.display = 'none';
            document.getElementById('app-screen').style.display = 'flex';
            
            initInventoryTabs();
            initInventory('bread');
            buildTables();
        }

        // --- Core Functions ---

        function resolveIcon(name, cat, customUrl = null) {
            if (customUrl) return `<img src="${customUrl}" alt="${name}">`;
            
            if (iconDictionary[name]) {
                const val = iconDictionary[name];
                if (typeof val === 'object' && val.type === 'img') return `<img src="${val.src}" alt="${name}">`;
                return `<span class="emoji">${val}</span>`;
            }

            for (const [key, val] of Object.entries(iconDictionary)) {
                if (typeof key === 'string' && key.length > 2 && name.includes(key)) {
                    if (typeof val === 'object' && val.type === 'img') return `<img src="${val.src}" alt="${name}">`;
                    return `<span class="emoji">${val}</span>`;
                }
            }
            
            const fallbackIcon = iconDictionary[cat] || 'ğŸ±';
            return `<span class="emoji">${fallbackIcon}</span>`;
        }

        function initInventoryTabs() {
            const container = document.querySelector('.tab-buttons');
            container.innerHTML = '';
            categories.forEach((cat, idx) => {
                const btn = document.createElement('div');
                btn.className = `tab-button ${idx===0?'active':''}`;
                btn.innerHTML = `${cat.icon} ${cat.name}`;
                btn.setAttribute('data-cat', cat.id); 
                btn.onclick = () => {
                    document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    initInventory(cat.id);
                };
                container.appendChild(btn);
            });
        }

        function initInventory(catId) {
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';
            const filtered = allInventoryItems.filter(i => i.cat === catId);
            filtered.forEach(item => {
                list.appendChild(createItemElement(item));
            });
        }

        function createItemElement(item) {
            const div = document.createElement('div');
            div.className = 'food-item';
            div.draggable = true;
            div.setAttribute('data-name', item.name);
            div.setAttribute('data-cat', item.cat);
            if(item.customUrl) div.setAttribute('data-custom-url', item.customUrl);
            div.innerHTML = `${resolveIcon(item.name, item.cat, item.customUrl)}<span>${item.name}</span>`;
            div.addEventListener('dragstart', drag);
            div.addEventListener('contextmenu', (e) => showContextMenu(e, item));
            return div;
        }

        // --- Adding Items ---
        function addNewItem() {
            const nameInput = document.getElementById('new-food-name');
            const catSelect = document.getElementById('new-food-cat');
            
            const name = nameInput.value.trim();
            if(!name) return alert('× × ×œ×”×§×œ×™×“ ×©× ×œ×××›×œ');
            
            let cat = catSelect.value;
            
            if (cat === 'auto') {
                cat = 'treat'; 
                if(['×œ×—×','×¤×™×ª×”','×˜×•×¡×˜','×œ×—×× ×™×”','×××¤×”','×‘×•×¨×§×¡','×¡× ×“×•×•×™×¥','×¤× ×§×™×™×§','×‘×™×™×’×œ×”','×‘×œ×™× ×¦×¡'].some(x => name.includes(x))) cat = 'bread';
                else if(['×’×‘×™× ×”','×—×‘×™×ª×”','×‘×™×¦×”','×˜×•× ×”','×¤×¡×˜×¨××”','×—×œ×‘×•×Ÿ','×××¨×—','×‘×•×œ×’×¨×™×ª'].some(x => name.includes(x))) cat = 'filling';
                else if(['××œ×¤×¤×•×Ÿ','×¢×’×‘× ×™×”','×™×¨×§','×ª×™×¨×¡','×’×–×¨','×’××‘×”','××‘×•×§×“×•','×–×™×ª×™×'].some(x => name.includes(x))) cat = 'veggie';
                else if(['×ª×¤×•×—','×‘× × ×”','×¤×¨×™','××’×¡','×¢× ×‘×™×','×ª×•×ª','×©×–×™×£','×× ×’×•','×§×™×•×•×™'].some(x => name.includes(x))) cat = 'fruit';
            }

            const newItem = { name, cat, customUrl: null };
            allInventoryItems.unshift(newItem);
            
            const activeTabElement = document.querySelector('.tab-button.active');
            const currentCatId = activeTabElement ? activeTabElement.getAttribute('data-cat') : 'bread';
            
            if (currentCatId !== cat) {
                const targetBtn = Array.from(document.querySelectorAll('.tab-button')).find(b => b.getAttribute('data-cat') === cat);
                if(targetBtn) targetBtn.click();
            } else {
                initInventory(cat);
            }
            
            nameInput.value = '';
            catSelect.value = 'auto'; 
        }
        
        function handleKeyPress(e) { if(e.key==='Enter') addNewItem(); }

        // --- Context Menu ---
        function showContextMenu(e, itemObj) {
            e.preventDefault();
            contextTargetItem = itemObj;
            const ctxMenu = document.getElementById('context-menu');
            ctxMenu.style.display = 'block';
            ctxMenu.style.left = e.pageX + 'px';
            ctxMenu.style.top = e.pageY + 'px';
        }
        document.addEventListener('click', () => document.getElementById('context-menu').style.display = 'none');

        function changeItemImage() {
            if(!contextTargetItem) return;
            const url = prompt('×”×›× ×¡ ×§×™×©×•×¨ ×œ×ª××•× ×” (URL) ××”××™× ×˜×¨× ×˜:', contextTargetItem.customUrl || '');
            if(url !== null) { 
                contextTargetItem.customUrl = url || null; 
                initInventory(contextTargetItem.cat);
            }
        }

        function deleteItemFromInventory() {
             if(!contextTargetItem) return;
             if(confirm('×œ××—×•×§ ××ª ' + contextTargetItem.name + ' ×œ×¦××™×ª×•×ª ××”××—×¡×Ÿ?')) {
                 allInventoryItems = allInventoryItems.filter(i => i !== contextTargetItem);
                 initInventory(contextTargetItem.cat);
             }
        }

        // --- Table Rendering ---
        function hexToRgba(hex, alpha) {
            let r=0, g=0, b=0;
            if (hex.length == 4) { r = "0x" + hex[1] + hex[1]; g = "0x" + hex[2] + hex[2]; b = "0x" + hex[3] + hex[3]; } 
            else if (hex.length == 7) { r = "0x" + hex[1] + hex[2]; g = "0x" + hex[3] + hex[4]; b = "0x" + hex[5] + hex[6]; }
            return `rgba(${+r},${+g},${+b},${alpha})`;
        }

        function buildTables() {
            const container = document.getElementById('tables-container');
            container.innerHTML = '';
            childrenData.forEach(child => {
                const card = document.createElement('div');
                card.className = 'single-child-table';
                const title = document.createElement('div');
                title.className = 'child-title';
                title.innerText = '×”×ª×¤×¨×™×˜ ×©×œ ' + child.name;
                title.style.backgroundColor = child.color;
                card.appendChild(title);

                const grid = document.createElement('div');
                grid.className = 'week-grid';
                grid.style.backgroundColor = hexToRgba(child.color, 0.3);

                grid.appendChild(createCell('header-cell', '×§×˜×’×•×¨×™×”'));
                days.forEach(day => grid.appendChild(createCell('header-cell day-header', day)));

                categories.forEach(cat => {
                    const ch = document.createElement('div');
                    ch.className = 'header-cell cat-header';
                    ch.innerHTML = `<span class="emoji-icon">${cat.icon}</span><span>${cat.name}</span>`;
                    grid.appendChild(ch);
                    days.forEach(day => {
                        const slot = document.createElement('div');
                        slot.className = 'day-cell child-slot';
                        slot.setAttribute('data-cat', cat.id);
                        slot.onclick = showItemSelector; 
                        slot.addEventListener('dragover', allowDrop);
                        slot.addEventListener('drop', drop);
                        grid.appendChild(slot);
                    });
                });
                card.appendChild(grid);
                container.appendChild(card);
            });
        }

        function createCell(cls, txt) {
            const d = document.createElement('div');
            d.className = cls;
            d.innerText = txt;
            return d;
        }

        function populateCell(targetCell, item) {
            targetCell.innerHTML = '';
            if (!item) { targetCell.classList.remove('filled'); return; }
            const div = createItemElement(item);
            div.addEventListener('dragstart', drag); 
            targetCell.appendChild(div);
            targetCell.classList.add('filled');
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'cell-menu-btn';
            deleteBtn.innerHTML = 'x';
            deleteBtn.title = '××—×™×§×” ××”×™×¨×”';
            deleteBtn.onclick = (e) => { e.stopPropagation(); deleteItemFromCell(targetCell); };
            targetCell.appendChild(deleteBtn);
        }

        // --- Selector / Helper Functions ---
        function showItemSelector(e) {
            if (e.dataTransfer) return; 
            const cell = e.currentTarget;
            currentCellTarget = cell;
            const catId = cell.getAttribute('data-cat');
            const category = categories.find(c => c.id === catId);
            document.getElementById('selector-title').innerText = `×‘×—×™×¨×ª ${category ? category.name : '×¤×¨×™×˜'} ğŸ½ï¸`;
            const list = document.getElementById('item-selector-list');
            list.innerHTML = '';
            const filtered = allInventoryItems.filter(i => i.cat === catId);
            filtered.forEach(item => {
                const itemEl = createItemElement(item);
                itemEl.draggable = false;
                itemEl.onclick = () => selectItemForCell(item);
                list.appendChild(itemEl);
            });
            document.getElementById('item-selector-modal').style.display = 'flex';
        }

        function selectItemForCell(item) {
            if (currentCellTarget) { populateCell(currentCellTarget, item); }
            document.getElementById('item-selector-modal').style.display = 'none';
        }

        function deleteItemFromCell(cell = currentCellTarget) {
            if (cell) { populateCell(cell, null); }
            document.getElementById('item-selector-modal').style.display = 'none';
        }

        // --- Drag & Drop ---
        function drag(ev) {
            const data = {
                name: ev.target.getAttribute('data-name'),
                cat: ev.target.getAttribute('data-cat'),
                customUrl: ev.target.getAttribute('data-custom-url') || null
            };
            ev.dataTransfer.setData("application/json", JSON.stringify(data));
        }

        function allowDrop(ev) { ev.preventDefault(); }

        function drop(ev) {
            ev.preventDefault();
            let target = ev.target.closest('.child-slot');
            if(!target) return;
            const rawData = ev.dataTransfer.getData("application/json");
            if(!rawData) return;
            populateCell(target, JSON.parse(rawData));
        }

        function trashDrop(ev) {
            ev.preventDefault();
            const rawData = ev.dataTransfer.getData("application/json");
            if(rawData) {
                const draggedItem = document.querySelector(`[data-name="${JSON.parse(rawData).name}"]`);
                const itemSlot = draggedItem ? draggedItem.closest('.day-cell') : null;
                if (itemSlot) populateCell(itemSlot, null); 
            }
        }
        
        // --- Shopping List & Tools ---
        function showShoppingList() {
            const items = document.querySelectorAll('.child-slot .food-item');
            shoppingListSummary = {};
            items.forEach(i => {
                const name = i.getAttribute('data-name');
                const cat = i.getAttribute('data-cat');
                const customUrl = i.getAttribute('data-custom-url');
                if (!shoppingListSummary[name]) { shoppingListSummary[name] = { count: 0, cat: cat, customUrl: customUrl }; }
                shoppingListSummary[name].count++;
            });
            const cont = document.getElementById('shopping-list-items');
            cont.innerHTML = '';
            if (Object.keys(shoppingListSummary).length === 0) {
                cont.innerHTML = '<p style="text-align:center">×”×œ×•×— ×¨×™×§, ××™×Ÿ ××” ×œ×§× ×•×ª! ğŸ¤·â€â™‚ï¸</p>';
            } else {
                for (let [name, item] of Object.entries(shoppingListSummary)) {
                    const row = document.createElement('div');
                    row.className = 'shopping-item';
                    const iconContent = resolveIcon(name, item.cat, item.customUrl);
                    row.innerHTML = `<span class="icon-and-name">${iconContent} ${name}</span><span>${item.count}</span>`;
                    cont.appendChild(row);
                }
            }
            document.getElementById('shopping-modal').style.display = 'flex';
        }

        function getIconText(name, cat, customUrl = null) {
            const resolved = resolveIcon(name, cat, customUrl);
            if (resolved.startsWith('<img')) return 'ğŸ–¼ï¸';
            const match = resolved.match(/<span class="emoji">(.*?)<\/span>/);
            return match ? match[1] : 'â–ªï¸';
        }

        function copyToWhatsapp() {
            let listText = "×¨×©×™××ª ×§× ×™×•×ª ×©×‘×•×¢×™×ª: \n\n";
            for (let [name, item] of Object.entries(shoppingListSummary)) {
                const icon = getIconText(name, item.cat, item.customUrl);
                listText += `${icon} ${name} (${item.count})\n`;
            }
            navigator.clipboard.writeText(listText).then(() => {
                alert("×”×¨×©×™××” ×”×•×¢×ª×§×” ×‘×”×¦×œ×—×”! × ×™×ª×Ÿ ×œ×”×“×‘×™×§ ××•×ª×” ×‘×•×•××˜×¡××¤. ğŸ“‹");
            }, () => { alert('×©×’×™××” ×‘×”×¢×ª×§×”, ×× × × ×¡×• ×©×•×‘.'); });
        }

        function clearTable() { if(confirm('×œ× ×§×•×ª ××ª ×›×œ ×”×ª×¤×¨×™×˜×™× ××›×œ ×”×™×œ×“×™×?')) document.querySelectorAll('.child-slot').forEach(e => populateCell(e, null)); }

        function autoFillMenu() {
            const slots = document.querySelectorAll('.child-slot');
            if(slots.length > 0 && slots[0].querySelector('.food-item') && !confirm('×”×œ×•×—×•×ª ×›×‘×¨ ××œ××™× ×‘×—×œ×§×. ×œ×“×¨×•×¡ ××ª ×”×›×œ?')) return;
            slots.forEach(slot => {
                const cat = slot.getAttribute('data-cat');
                const relevant = allInventoryItems.filter(i => i.cat === cat);
                if(relevant.length) {
                    const item = relevant[Math.floor(Math.random()*relevant.length)];
                    populateCell(slot, item);
                } else {
                    populateCell(slot, null);
                }
            });
        }
    </script>
</body>
</html>